@{
    ViewData["Title"] = "Keyword Analytics";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-graph-up"></i> Keyword Analytics: <span id="keywordName" class="text-primary">-</span></h2>
        <a href="@Url.Action("Index", "Keywords")" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Keywords
        </a>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 id="totalMessages" class="text-primary">-</h3>
                    <p class="text-muted mb-0">Total Messages</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 id="optIns" class="text-success">-</h3>
                    <p class="text-muted mb-0">Opt-Ins</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 id="optOuts" class="text-danger">-</h3>
                    <p class="text-muted mb-0">Opt-Outs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 id="conversionRate" class="text-info">-</h3>
                    <p class="text-muted mb-0">Success Rate</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Message Volume Over Time</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active" onclick="changePeriod('7d')">7 Days</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="changePeriod('30d')">30 Days</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="changePeriod('90d')">90 Days</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="messageChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Opt-In vs Opt-Out</h5>
                </div>
                <div class="card-body">
                    <canvas id="conversionChart"></canvas>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-circle-fill text-success"></i> Opt-Ins</span>
                            <strong id="optInPercent">-</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-circle-fill text-danger"></i> Opt-Outs</span>
                            <strong id="optOutPercent">-</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Top Hours for Engagement</h5>
                </div>
                <div class="card-body">
                    <canvas id="hourlyChart" height="150"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Day of Week Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="dayChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Recent Subscribers</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="subscribersTable">
                    <thead>
                        <tr>
                            <th>Phone Number</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Source</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const apiBaseUrl = '@ViewBag.ApiBaseUrl';
        const keywordId = window.location.pathname.split('/').pop();
        let messageChart, conversionChart, hourlyChart, dayChart;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalytics();
        });

        async function loadAnalytics() {
            try {
                // Mock data for demonstration
                const mockData = {
                    keyword: 'JOIN',
                    totalMessages: 1247,
                    optIns: 1180,
                    optOuts: 67,
                    conversionRate: 94.6,
                    messageVolume: [
                        { date: '2024-03-14', messages: 145 },
                        { date: '2024-03-15', messages: 168 },
                        { date: '2024-03-16', messages: 192 },
                        { date: '2024-03-17', messages: 156 },
                        { date: '2024-03-18', messages: 178 },
                        { date: '2024-03-19', messages: 203 },
                        { date: '2024-03-20', messages: 205 }
                    ],
                    hourlyData: [12, 8, 5, 3, 2, 5, 15, 45, 67, 89, 92, 88, 95, 78, 72, 85, 93, 87, 65, 52, 38, 28, 20, 15],
                    dayData: [156, 178, 192, 168, 203, 205, 145],
                    recentSubscribers: [
                        { phone: '+1234567890', status: 'Opted In', date: '2024-03-20 14:30', source: 'SMS' },
                        { phone: '+1234567891', status: 'Opted In', date: '2024-03-20 13:15', source: 'SMS' },
                        { phone: '+1234567892', status: 'Opted Out', date: '2024-03-20 11:45', source: 'SMS' },
                        { phone: '+1234567893', status: 'Opted In', date: '2024-03-20 10:20', source: 'SMS' },
                        { phone: '+1234567894', status: 'Opted In', date: '2024-03-19 16:30', source: 'SMS' }
                    ]
                };
                
                updateStats(mockData);
                createCharts(mockData);
                renderSubscribers(mockData.recentSubscribers);
            } catch (error) {
                alert('Error loading analytics: ' + error.message);
            }
        }

        function updateStats(data) {
            document.getElementById('keywordName').textContent = data.keyword;
            document.getElementById('totalMessages').textContent = data.totalMessages.toLocaleString();
            document.getElementById('optIns').textContent = data.optIns.toLocaleString();
            document.getElementById('optOuts').textContent = data.optOuts.toLocaleString();
            document.getElementById('conversionRate').textContent = data.conversionRate.toFixed(1) + '%';
            
            const optInPercent = (data.optIns / data.totalMessages * 100).toFixed(1);
            const optOutPercent = (data.optOuts / data.totalMessages * 100).toFixed(1);
            document.getElementById('optInPercent').textContent = optInPercent + '%';
            document.getElementById('optOutPercent').textContent = optOutPercent + '%';
        }

        function createCharts(data) {
            // Message Volume Chart
            const messageCtx = document.getElementById('messageChart').getContext('2d');
            messageChart = new Chart(messageCtx, {
                type: 'line',
                data: {
                    labels: data.messageVolume.map(d => d.date),
                    datasets: [{
                        label: 'Messages',
                        data: data.messageVolume.map(d => d.messages),
                        borderColor: 'rgb(13, 110, 253)',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Conversion Pie Chart
            const conversionCtx = document.getElementById('conversionChart').getContext('2d');
            conversionChart = new Chart(conversionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Opt-Ins', 'Opt-Outs'],
                    datasets: [{
                        data: [data.optIns, data.optOuts],
                        backgroundColor: ['rgb(25, 135, 84)', 'rgb(220, 53, 69)']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Hourly Chart
            const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
            hourlyChart = new Chart(hourlyCtx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Messages per Hour',
                        data: data.hourlyData,
                        backgroundColor: 'rgba(13, 110, 253, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Day of Week Chart
            const dayCtx = document.getElementById('dayChart').getContext('2d');
            dayChart = new Chart(dayCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Messages per Day',
                        data: data.dayData,
                        backgroundColor: 'rgba(25, 135, 84, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function renderSubscribers(subscribers) {
            const tbody = document.querySelector('#subscribersTable tbody');
            
            if (!subscribers || subscribers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No subscribers found</td></tr>';
                return;
            }
            
            let html = '';
            subscribers.forEach(sub => {
                const statusClass = sub.status === 'Opted In' ? 'success' : 'danger';
                html += `
                    <tr>
                        <td>${sub.phone}</td>
                        <td><span class="badge bg-${statusClass}">${sub.status}</span></td>
                        <td>${sub.date}</td>
                        <td>${sub.source}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewContact('${sub.phone}')">
                                <i class="bi bi-person"></i> View Contact
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function changePeriod(period) {
            document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            alert(`Loading ${period} data... (Demo)`);
        }

        function viewContact(phone) {
            alert(`View contact details for ${phone} (Demo)`);
        }
    </script>
}
